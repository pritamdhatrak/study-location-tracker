<!DOCTYPE html>
<html>
<head>
    <title>Study Tracker</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; }
        .section { border: 2px solid #ccc; margin: 15px 0; padding: 15px; }
        .btn { background: #007bff; color: white; padding: 10px 15px; margin: 5px; border: none; cursor: pointer; }
        canvas { border: 2px solid #000; background: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📚 Study Location Tracker</h1>
        
        <div class="section">
            <h3>📍 Location Status</h3>
            <div id="locationInfo">Click button to get location</div>
            <button class="btn" onclick="getMyLocation()">Get Location</button>
        </div>
        
        <div class="section">
            <h3>⏰ Study Timer</h3>
            <canvas id="myCanvas" width="400" height="200"></canvas><br>
            <button class="btn" onclick="startStudying()">Start Timer</button>
            <button class="btn" onclick="stopStudying()">Stop Timer</button>
            <div id="timerInfo">Time: 0:00</div>
        </div>
        
        <div class="section">
            <h3>📚 Session History</h3>
            <div id="sessionInfo">No sessions saved yet</div>
        </div>
    </div>

    <script>
        console.log('JavaScript starting...');
        
        var studySeconds = 0;
        var isRunning = false;
        var userLocation = null;
        var myCanvas = document.getElementById('myCanvas');
        var ctx = myCanvas.getContext('2d');
        
        function getMyLocation() {
            console.log('Getting location...');
            document.getElementById('locationInfo').innerHTML = 'Getting your location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log('Location found:', position);
                        userLocation = position;
                        var lat = position.coords.latitude.toFixed(6);
                        var lon = position.coords.longitude.toFixed(6);
                        document.getElementById('locationInfo').innerHTML = 'Location: ' + lat + '°, ' + lon + '°';
                        drawCanvas();
                    },
                    function(error) {
                        console.log('Location error:', error);
                        document.getElementById('locationInfo').innerHTML = 'Location error: ' + error.message;
                    }
                );
            } else {
                document.getElementById('locationInfo').innerHTML = 'Geolocation not supported';
            }
        }
        
        function startStudying() {
            console.log('Starting timer...');
            if (!isRunning) {
                isRunning = true;
                updateTimer();
            }
        }
        
        function stopStudying() {
            console.log('Stopping timer...');
            isRunning = false;
            if (studySeconds > 0) {
                saveMySession();
            }
            studySeconds = 0;
            drawCanvas();
        }
        
        function updateTimer() {
            if (isRunning) {
                requestIdleCallback(function() {
                    studySeconds++;
                    var minutes = Math.floor(studySeconds / 60);
                    var seconds = studySeconds % 60;
                    document.getElementById('timerInfo').innerHTML = 'Time: ' + minutes + ':' + seconds.toString().padStart(2, '0');
                    drawCanvas();
                    setTimeout(updateTimer, 1000);
                });
            }
        }
        
        function drawCanvas() {
            // Clear canvas
            ctx.clearRect(0, 0, 400, 200);
            
            // Background
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, 400, 200);
            
            // Timer circle
            ctx.beginPath();
            ctx.arc(100, 100, 60, 0, Math.PI * 2);
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 8;
            ctx.stroke();
            
            // Progress
            if (studySeconds > 0) {
                var progress = (studySeconds % 60) / 60;
                ctx.beginPath();
                ctx.arc(100, 100, 60, -Math.PI/2, (-Math.PI/2) + (progress * Math.PI * 2));
                ctx.strokeStyle = '#007bff';
                ctx.lineWidth = 8;
                ctx.stroke();
            }
            
            // Timer text
            ctx.fillStyle = 'black';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            var mins = Math.floor(studySeconds / 60);
            var secs = studySeconds % 60;
            ctx.fillText(mins + ':' + secs.toString().padStart(2, '0'), 100, 105);
            
            // Location visualization
            if (userLocation) {
                ctx.fillStyle = '#e3f2fd';
                ctx.fillRect(250, 50, 100, 100);
                
                // Location dot
                ctx.beginPath();
                ctx.arc(300, 100, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#1976d2';
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.fillText('Your Location', 300, 130);
            } else {
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(250, 50, 100, 100);
                ctx.strokeRect(250, 50, 100, 100);
                ctx.fillStyle = 'gray';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No Location', 300, 100);
            }
        }
        
        function saveMySession() {
            console.log('Saving session...');
            
            if (!userLocation) {
                document.getElementById('sessionInfo').innerHTML = 'Cannot save: No location available';
                return;
            }
            
            var sessionData = {
                duration: studySeconds,
                location: {
                    latitude: userLocation.coords.latitude,
                    longitude: userLocation.coords.longitude
                }
            };
            
            // Simple fetch request
            fetch('/api/sessions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sessionData)
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                console.log('Session saved:', data);
                var mins = Math.floor(studySeconds / 60);
                document.getElementById('sessionInfo').innerHTML = 'Session saved: ' + mins + ' minutes';
            })
            .catch(function(error) {
                console.log('Save error:', error);
                document.getElementById('sessionInfo').innerHTML = 'Session saved locally';
            });
        }
        
        // Initialize
        console.log('Initializing app...');
        drawCanvas();
        
        // Auto-get location after 3 seconds
        setTimeout(function() {
            getMyLocation();
        }, 3000);
        
        console.log('App ready!');
    </script>
</body>
</html>
